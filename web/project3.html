<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="shortcut icon" href="#">
        <link href="cssFile.css" rel="stylesheet">
        

                

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
        
        <script type="text/javascript" src="eel.js"></script>
        <!-- <script src="https://d3js.org/d3.v5.min.js"></script> -->
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <title>PROJECT-3</title>
    </head>

    <body>
        <div style="display:inline-block; margin-right: 1100px;">
            <label class="label1">SELECT YEAR:</label>
            <select style="display:inline-block"title="Select Year" id="selYear" onchange="optionChanged(this.value)"></select>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="button-7"  title="THIS BUTON WHILE WE CREATE AND TEST THE DB DATA" onclick="eel.updateDatabase()();">READ DATABASE</button>
        </div>
        <div style="display:inline-block">
            <label class="label1">SELECT STATE:</label>
            <select style="display:inline-block"title="Select State" id="selState" onchange="stOptionChanged(this.value)"></select>
        </div>&nbsp;&nbsp;&nbsp;&nbsp;
        <div style="width: 500px; height: 500px;" id="mapDiv"></div>
        <br>
        <div style="display:inline-block;" class="bodyDiv" id="plot"></div><br><br>
        <div style="display:inline-block;" class="bodyDiv" id="plot2"></div><br><br>
        <br>
        <div  id="onPageMessage" class="onPageMessage"></div>
        <br>
        <div  class="bodyDiv sortable" id="table"></div>
        
        <!-- <div class="bodyDiv" id="content2"></div>           -->
    </body>
</html>

<!-- javaScritp IF it is easier fo you guys we can put this in a .js file... -->
<script>
    cPrev = -1;
    window.onload =  getDataFromPython;
    var states = [
            'Alaska',	
            'Arizona',	
            'Arkansas',	
            'California',	
            'Colorado',	
            'Connecticut',	
            'Delaware',	
            'Florida',	
            'Georgia',	
            'Hawaii',	
            'Idaho',	
            'Illinois',	
            'Indiana',	
            'Iowa',	
            'Kansas',	
            'Kentucky',	
            'Louisiana',	
            'Maine',	
            'Maryland',	
            'Massachusetts',	
            'Michigan',	
            'Minnesota',	
            'Mississippi',	
            'Missouri',	
            'Montana',	
            'Nebraska',	
            'Nevada',	
            'New Hampshire',	
            'New Jersey',	
            'New Mexico',	
            'New York',	
            'North Carolina',
            'North Dakota','Ohio',	
            'Oklahoma',	
            'Oregon',
            'Pennsylvania',	
            'Rhode Island',
            'South Carolina',
            'South Dakota',
            'Tennessee',
            'Texas',
            'Utah',
            'Vermont',
            'Virginia',
            'Washington',
            'West Virginia',
            'Wisconsin',
            'Wyoming',
            'American Samoa',
            'District of Columbia',
            'Federated States of Micronesia',
            'Guam',
            'Marshall Islands',
            'Northern Mariana Islands',
            'Palau',
            'Puerto Rico',
            'Virgin Islands'
        ]

    eel.expose(getDataFromPython);
    async function getDataFromPython() {
        globalThis.data = await eel.collectData()(); //needs to be a global var so we can access it from any function. 
        iterateDict();
        populateYear();
    };

    function iterateDict(){
        var options = ['','2011', '2012','2013','2014','2015','2016','2017','2018','2019','2020', '2021'];
        var select = document.getElementById("selYear");
        for(var i = 0; i < options.length; i++) {
            var opt = options[i];
            var el = document.createElement("option");
            el.textContent = opt;
            el.value = opt;
            select.appendChild(el);
        }
    };

    function populateYear(){
        var listOfActualStates = [];
        data.forEach((element) => {
            listOfActualStates.push(element.LocationDesc);
        });
        const uniqueActualStates = listOfActualStates.filter((value, index) => listOfActualStates.indexOf(value) === index);
        uniqueActualStates.unshift("");
        // console.log(uniqueActualStates);
        stateSelected = document.getElementById("selState");
        for(var i = 0; i < uniqueActualStates.length; i++) {
            var opt = uniqueActualStates[i];
            var el = document.createElement("option");
            el.textContent = opt;
            el.value = opt;
            stateSelected.appendChild(el);
        }
    };
    function stOptionChanged(stateSelected){
        document.getElementById("onPageMessage").innerText = "";
        if (stateSelected == ""){
            document.getElementById("mapDiv").innerText = "";
            return
        }
        // collect the 

        var wholeThingList = [];
        data.forEach((element) => {
            tempList = [];
            if (element.LocationDesc == stateSelected){
                for (const [key, value] of Object.entries(element)) {
                    // console.log(`${key}: ${value}`);
                    // console.log(value); 
                    tempList.push(value);
                    // yval.push(key);
                };
                wholeThingList.push(tempList);
            }
        
        });
        // wholeThingList[0] is the year
        // wholeThingList[1] is the State
        question = [];
       
        wholeThingList.forEach((el) => {
            q = el[2];
            tempList = [];
            if (q.includes("Percent of adults aged 18 years and older who have obesity")){
                // console.log("here    " + el[0])
                year = el[0];
                state = el[1];
                percentage = el[3];
                ageRange = el[4];
                coordinates = el[5];
                tempList.push([q,year,state,percentage,ageRange,coordinates]);
            }   
            // question.push(question);
            
            question.push(tempList);


            // console.log(el);
        });

        // console.log(coordinates); // is the Question;
        // wholeThingList[0] is the percentage
        // wholeThingList[0] is the age range
        // wholeThingList[0] is the state coordinates which are the same from all. 
        // console.log(wholeThingList);
        //create a Table Object
        var result = "<table id='sortable' border=1> <thead> <tr><th onclick='sortBy(0)'>YEAR</th><th onclick='sortBy(1)'>State</th><th onclick='sortBy(2)'>Question</th><th onclick='sortBy(3)'>Percentage</th><th onclick='sortBy(4)'>Age Range</th><th onclick='sortBy(5)'>Coordinates</th></tr></thead>";
            for(var i=0; i<wholeThingList.length; i++) {
                result += "<tr>";
                for(var j=0; j<wholeThingList[i].length; j++){
                    result += "<td>"+wholeThingList[i][j]+"</td>";
                }
                result += "</tr>";
            }
            result += "</table>";
        document.getElementById("table").innerHTML = result;
        // console.log(wholeThingList);


        addMap(coordinates);
    };

    function addMap(coordinates) {
        
        var cordinates = coordinates.split(",");
        var lat = coordinates.split("(");
        // console.log(cordinates);
        lat = cordinates[0].replace("(", "");
        lon = cordinates[1].replace(")", "");
        lat1 = parseFloat(lat);
        lon1 = parseFloat(lon);
        console.log(lat1);
        console.log(lon1);
        // lat.replace("(") //.replace(")");
        // console.log(lat);
        // lon = coordinates[1].replace("(").replace(")");
        // console.log(lat);
        // console.log(lon);
        try{
            map.remove();
        }catch (e){
            console.log("NORMAL THE FIRST TIME IT RUNS");
        };

        var map = L.map('mapDiv').setView([lat1, lon1], 13);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',

        }).addTo(map);

    };


    function optionChanged(yearSelected) {
        document.getElementById("onPageMessage").innerText = "";
        if (yearSelected == ""){
            document.getElementById("plot").innerText = "";
            return
        }
        addPlot(yearSelected);
        createLineChart();
    };

    function addPlot(yearSelected) {
        ySelectedArray = [];
        yearAgeRange = [];
        data.forEach((element) => {
            if (element.YearEnd == yearSelected){
                ySelectedArray.push(element);
                yearAgeRange.push(element.Age_year)
            }
        });
        var dictOfStates = {};
        var dictofRanges = {};
        // console.log("state" + states); y axis obesity percentage --- average by year. 

        // yearAgeRange.forEach(() => { 


        // });

        states.forEach((st) => {
            dataValue = 0
                count = 0
            ySelectedArray.forEach((element) => {  
                if (element.LocationDesc == st ){
                    count = count + 1
                    dataValue = Number(dataValue) + Number(element.Data_Value)
                }
                dVal = (Number(dataValue) / Number(count));
                if (dVal == "NaN"){
                    dVal = "0";
                }   
                dictOfStates[st] = dVal .toFixed(2);
            });
        });
        const sortedByVal = Object.fromEntries(
            Object.entries(dictOfStates).sort(([,a],[,b]) => a-b)
        );

        xval = [];
        yval = []
        for (const [key, value] of Object.entries(sortedByVal)) {
            // console.log(`${key}: ${value}`);
            if (isNaN(value)){
                continue;
            }
            // console.log(value); 
            xval.push(value);
            yval.push(key);
        };

        let trace = {
            y: xval,
            x: yval,
            lable: yearSelected,
            
            type: 'bar',
            // orientation:"h",
            mode: 'lines+markers',
            marker: { color: "cyan-blue" },
        };

        let layout = {
            margin: { 
                t:25, 
                b:150,
                l: 25,
                r: 10,
            },
            width: 1400,
            height: 500,
            title: "COMBINED PERCENTAGE (AVE) PER STATE FOR THE YEAR " + yearSelected 
        };

        Plotly.newPlot("plot", [ trace ], layout);
        };

    eel.expose(updateMessage);
    function updateMessage(message) {
        document.getElementById("onPageMessage").innerHTML = message;
    };

    function sortBy(c) {
    rows = document.getElementById("sortable").rows.length; // num of rows
    columns = document.getElementById("sortable").rows[0].cells.length; // num of columns
    arrTable = [...Array(rows)].map(e => Array(columns)); // create an empty 2d array

    for (ro=0; ro<rows; ro++) { // cycle through rows
        for (co=0; co<columns; co++) { // cycle through columns
            // assign the value in each row-column to a 2d array by row-column
            arrTable[ro][co] = document.getElementById("sortable").rows[ro].cells[co].innerHTML;
        }
    }

    th = arrTable.shift(); // remove the header row from the array, and save it
    
    if (c !== cPrev) { // different column is clicked, so sort by the new column
        arrTable.sort(
            function (a, b) {
                if (a[c] === b[c]) {
                    return 0;
                } else {
                    return (a[c] < b[c]) ? -1 : 1;
                }
            }
        );
    } else { // if the same column is clicked then reverse the array
        arrTable.reverse();
    }
    
    cPrev = c; // save in previous c

    arrTable.unshift(th); // put the header back in to the array

    // cycle through rows-columns placing values from the array back into the html table
    for (ro=0; ro<rows; ro++) {
        for (co=0; co<columns; co++) {
            document.getElementById("sortable").rows[ro].cells[co].innerHTML = arrTable[ro][co];
        }
    }
}

function createLineChart() {
    // Extract the necessary data from your source or modify it as per your requirements
    // console.log(data);
    const yearData = [
        { year: 2011, value: 32 },
        { year: 2012, value: 28 },
        { year: 2013, value: 32 },
        { year: 2014, value: 29 },
        { year: 2015, value: 32 },
        { year: 2016, value: 29 },
        { year: 2017, value: 31 },
        { year: 2018, value: 30 },
        { year: 2019, value: 33 },
        { year: 2020, value: 30 },
        { year: 2021, value: 31 }
    ];
    // Extract x and y values from the data
    console.log(data);
    const xValues = yearData.map(data => data.year);
    const yValues = yearData.map(data => data.value);
    // Create a trace for the line chart
    const trace = {
        x: xValues,
        y: yValues,
        type: 'scatter',
        mode: 'lines+markers',
        marker: {
            color: 'blue'
        }
    };
    // Create a layout for the line chart
    const layout = {
        title: 'Percentage of Adults with Obesity Year Over Year',
        xaxis: {
            title: 'Year',
            tickvals: xValues,
            tickmode: 'linear',
            tickangle: -25
        },
        yaxis: {
            title: 'Percentage',
            range: [25, 40] // Set the range from 0 to 50 on the y-axis
        },
        height: 500,
        width: 800
    };
    // Plot the line chart
    Plotly.newPlot('plot2', [trace], layout);
}
// Call the function to create the line chart on page load
// window.addEventListener('DOMContentLoaded', createLineChart);
    
</script>
